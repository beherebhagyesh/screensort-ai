<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ScreenSort AI</title>
    <link href="/manifest.json" rel="manifest">
    <meta name="theme-color" content="#111318">
    
    <!-- CSS -->
    <link href="/styles.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />

    <!-- Chart.js (Optional, failure won't break app structure) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- Top App Bar -->
    <header style="position: sticky; top: 0; background: var(--md-sys-color-surface); z-index: 100; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">auto_awesome</span>
            <span class="md-title-large">ScreenSort</span>
        </div>
        <div id="header-actions">
            <!-- Dynamic actions based on view -->
            <button onclick="fetchData()" style="background: none; border: none; color: var(--md-sys-color-on-surface); cursor: pointer;">
                <span class="material-symbols-outlined">refresh</span>
            </button>
        </div>
    </header>

    <!-- VIEWS -->
    <main id="main-content" style="padding: 0 16px 96px 16px;">
        
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="view-section">
            <!-- Stats Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div class="md-card">
                    <span class="md-body-medium">Total Items</span>
                    <div style="font-size: 32px; font-weight: 700; color: var(--md-sys-color-primary);" id="stat-total">...</div>
                </div>
                <div class="md-card">
                    <span class="md-body-medium">Storage</span>
                    <div style="font-size: 32px; font-weight: 700; color: var(--md-sys-color-tertiary);" id="stat-storage">...</div>
                </div>
            </div>

            <!-- Charts Area -->
            <div class="md-card" style="margin-bottom: 16px; min-height: 200px;">
                <canvas id="activityChart"></canvas>
            </div>

            <div class="md-card" style="margin-bottom: 16px; min-height: 200px;">
                <canvas id="categoryChart"></canvas>
            </div>

            <!-- Recent Activity -->
            <h3 class="md-title-large" style="margin-bottom: 12px;">Recent</h3>
            <div id="recent-list" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Recent items injected here -->
            </div>
        </div>

        <!-- GALLERY VIEW -->
        <div id="view-gallery" class="view-section" style="display: none;">
            <h3 class="md-title-large" style="margin-bottom: 16px;">Categories</h3>
            <div id="category-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                <!-- Categories injected here -->
            </div>
        </div>

        <!-- CATEGORY DETAILS VIEW (Hidden by default) -->
        <div id="view-category-details" class="view-section" style="display: none;">
            <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
                <button onclick="switchView('view-gallery')" style="background:none; border:none; color: var(--md-sys-color-on-surface); cursor: pointer;">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h3 id="cat-detail-title" class="md-title-large">Category</h3>
            </div>
            <div id="cat-detail-grid" class="gallery-grid">
                <!-- Images injected here -->
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="view-settings" class="view-section" style="display: none;">
             <div class="md-card">
                <h3>App Info</h3>
                <p class="md-body-medium">Version: 2.0 (Material)</p>
                <p class="md-body-medium">Storage Path: /sdcard/Pictures/Screenshots</p>
            </div>
        </div>

    </main>

    <!-- SEARCH OVERLAY (Full screen) -->
    <div id="search-overlay" style="position: fixed; inset: 0; background: var(--md-sys-color-background); z-index: 200; padding: 16px; display: none; flex-direction: column;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <button onclick="toggleSearch()" style="background:none; border:none; color: var(--md-sys-color-on-surface);">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <input type="text" id="search-input" placeholder="Search text in screenshots..." 
                   style="flex: 1; background: var(--md-sys-color-surface-container-high); border: none; padding: 12px 16px; border-radius: 24px; color: white; font-size: 16px; outline: none;">
        </div>
        <div id="search-results" style="overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 12px;"></div>
    </div>

    <!-- IMAGE VIEWER MODAL -->
    <div id="image-viewer" style="position: fixed; inset: 0; background: black; z-index: 300; display: none; flex-direction: column; justify-content: center;">
        <button onclick="closeImageViewer()" style="position: absolute; top: 16px; left: 16px; background: rgba(0,0,0,0.5); border: none; color: white; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
            <span class="material-symbols-outlined">close</span>
        </button>
        <img id="viewer-img" src="" style="max-width: 100%; max-height: 80vh; object-fit: contain;">
        <div id="viewer-details" style="padding: 16px; color: white; background: rgba(0,0,0,0.8); position: absolute; bottom: 0; width: 100%;">
            <h4 id="viewer-filename" style="margin: 0 0 8px 0;">Filename</h4>
            <p id="viewer-date" style="font-size: 12px; opacity: 0.7; margin: 0;">Date</p>
        </div>
    </div>

    <!-- FAB -->
    <button class="md-fab" onclick="toggleSearch()">
        <span class="material-symbols-outlined">search</span>
    </button>

    <!-- Bottom Navigation -->
    <nav class="md-navbar">
        <button class="md-nav-item active" onclick="switchView('view-dashboard', this)">
            <div class="icon-container"><span class="material-symbols-outlined">dashboard</span></div>
            <span>Dash</span>
        </button>
        <button class="md-nav-item" onclick="switchView('view-gallery', this)">
            <div class="icon-container"><span class="material-symbols-outlined">photo_library</span></div>
            <span>Gallery</span>
        </button>
        <button class="md-nav-item" onclick="switchView('view-settings', this)">
            <div class="icon-container"><span class="material-symbols-outlined">settings</span></div>
            <span>Settings</span>
        </button>
    </nav>

    <script>
        // --- Navigation Logic ---
        function switchView(viewId, navBtn) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            // Show target
            document.getElementById(viewId).style.display = 'block';

            // Update Nav State (if triggered by nav button)
            if (navBtn) {
                document.querySelectorAll('.md-nav-item').forEach(el => el.classList.remove('active'));
                navBtn.classList.add('active');
            }

            // Special Logic
            if (viewId === 'view-gallery') {
                loadCategories();
            }
        }

        function toggleSearch() {
            const el = document.getElementById('search-overlay');
            const isHidden = el.style.display === 'none';
            el.style.display = isHidden ? 'flex' : 'none';
            if (isHidden) document.getElementById('search-input').focus();
        }

        // --- Data Fetching ---
        let dashboardData = null;

        async function fetchData() {
            try {
                const res = await fetch('/api/dashboard');
                dashboardData = await res.json();
                renderDashboard(dashboardData);
            } catch (e) {
                console.error("Fetch failed", e);
            }
        }

        function renderDashboard(data) {
            // Stats
            document.getElementById('stat-total').textContent = data.total_photos || 0;
            document.getElementById('stat-storage').textContent = data.storage_usage || '0 MB';

            // Recent List
            const recentContainer = document.getElementById('recent-list');
            recentContainer.innerHTML = data.recent.map(item => `
                <div class="md-card md-card-clickable" onclick="openImage('${item.path}', '${item.name}', '${item.created_at}')" style="display: flex; gap: 16px; align-items: center; padding: 12px;">
                    <div style="width: 56px; height: 56px; border-radius: 8px; background-image: url('/images/${item.path.split('/').pop()}'); background-size: cover; background-position: center; background-color: #333;"></div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: 4px;">${item.category}</div>
                        <div style="font-size: 12px; opacity: 0.7;">${new Date(item.created_at).toLocaleDateString()}</div>
                    </div>
                    ${item.amount ? `<div style="color: var(--md-sys-color-primary); font-weight: 700;">$${item.amount}</div>` : ''}
                </div>
            `).join('');

            // Charts (Simplified)
            if (window.Chart) {
                renderCharts(data);
            }
        }

        function renderCharts(data) {
             const ctxActivity = document.getElementById('activityChart').getContext('2d');
             if (window.chartActivity) window.chartActivity.destroy();
             window.chartActivity = new Chart(ctxActivity, {
                type: 'line',
                data: {
                    labels: data.activity.map(d => d.date.slice(5)),
                    datasets: [{
                        label: 'Screenshots',
                        data: data.activity.map(d => d.count),
                        borderColor: '#a8c7fa',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
             });

             const ctxCat = document.getElementById('categoryChart').getContext('2d');
             if (window.chartCat) window.chartCat.destroy();
             window.chartCat = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: data.categories.map(c => c.name),
                    datasets: [{
                        data: data.categories.map(c => c.count),
                        backgroundColor: ['#a8c7fa', '#bec6dc', '#ddbce0', '#ffb4ab'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
             });
        }

        function loadCategories() {
            if (!dashboardData || !dashboardData.categories) return;
            const container = document.getElementById('category-list');
            container.innerHTML = dashboardData.categories.map(cat => `
                <div class="md-card md-card-clickable" onclick="openCategory('${cat.name}')" style="display: flex; flex-direction: column; align-items: center; justify-content: center; aspect-ratio: 1; text-align: center;">
                    <span class="material-symbols-outlined" style="font-size: 32px; margin-bottom: 8px; color: var(--md-sys-color-primary);">folder</span>
                    <div style="font-weight: 500;">${cat.name}</div>
                    <div style="font-size: 12px; opacity: 0.7;">${cat.count} items</div>
                </div>
            `).join('');
        }

        async function openCategory(name) {
            document.getElementById('cat-detail-title').textContent = name;
            switchView('view-category-details');
            
            const grid = document.getElementById('cat-detail-grid');
            grid.innerHTML = '<div style="padding: 20px;">Loading...</div>';

            try {
                const res = await fetch(`/api/category/${name}`);
                const data = await res.json();
                grid.innerHTML = data.files.map(file => `
                    <div class="gallery-item" onclick="openImage('/images/${name}/${file}', '${file}', '')">
                        <img src="/images/${name}/${file}" loading="lazy">
                    </div>
                `).join('');
            } catch (e) {
                grid.innerHTML = 'Error loading category.';
            }
        }

        function openImage(path, name, date) {
            // Fix path if it's full path
            let src = path;
            if (!src.startsWith('/')) src = '/images/' + path.split('/').pop(); // Simplified fallback
            // Actually, if we are in category view, path is constructed. 
            // Let's rely on the passed path being usable or relative.
            
            // If the path from API (recent) is full path "/sdcard/...", we need to map it to our static route.
            // Our server serves "/sdcard/Pictures/Screenshots" at "/images".
            // So if path is "/sdcard/Pictures/Screenshots/Finance/img.jpg", src should be "/images/Finance/img.jpg".
            if (path.includes('/sdcard/Pictures/Screenshots/')) {
                 src = path.replace('/sdcard/Pictures/Screenshots/', '/images/');
            }
            
            document.getElementById('viewer-img').src = src;
            document.getElementById('viewer-filename').textContent = name;
            document.getElementById('viewer-date').textContent = date || '';
            document.getElementById('image-viewer').style.display = 'flex';
        }

        function closeImageViewer() {
            document.getElementById('image-viewer').style.display = 'none';
        }

        // Search Logic
        document.getElementById('search-input').addEventListener('input', async (e) => {
            const q = e.target.value;
            if (q.length < 2) return;
            const res = await fetch(`/api/search?q=${q}`);
            const data = await res.json();
            document.getElementById('search-results').innerHTML = data.map(item => `
                <div class="md-card md-card-clickable" onclick="openImage('${item.path}', '${item.category}', '')">
                    <div style="font-weight: 500;">${item.category}</div>
                    <div style="font-size: 12px; opacity: 0.7;">${item.text_snippet || 'No text'}</div>
                </div>
            `).join('');
        });

        // Initialize
        fetchData();
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js');
        }
    </script>
</body>
</html>