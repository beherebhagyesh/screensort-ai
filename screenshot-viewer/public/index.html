<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ScreenSort AI Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2877f6",
                        "background-light": "#f1f2f4",
                        "background-dark": "#0f182a",
                        "glass-white": "rgba(255, 255, 255, 0.05)",
                        "glass-border": "rgba(255, 255, 255, 0.1)",
                        "neon-cyan": "#00f2ff",
                        "neon-purple": "#bc13fe",
                        "neon-lime": "#39ff14",
                        "chart-bg": "rgba(15, 24, 42, 0.6)"
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .mesh-gradient {
            background-color: #0f182a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(40, 119, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(188, 19, 254, 0.1) 0px, transparent 50%);
        }
        body { min-height: 100vh; }
        /* Custom Scrollbar for list */
        .scroller::-webkit-scrollbar { width: 4px; }
        .scroller::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-white min-h-screen mesh-gradient overflow-x-hidden pb-24">

    <!--Navbar -->
    <nav class="sticky top-0 z-50 flex items-center justify-between px-6 pt-6 pb-4 backdrop-blur-md bg-background-dark/50">
        <div class="flex items-center gap-3">
            <div class="size-10 rounded-full glass flex items-center justify-center border border-white/20">
                <span class="material-symbols-outlined text-primary text-xl">auto_awesome</span>
            </div>
            <h1 class="text-lg font-bold tracking-tight text-white">ScreenSort AI</h1>
        </div>
        <div class="flex gap-4">
             <button onclick="fetchData()" class="size-10 rounded-full glass flex items-center justify-center hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined text-white/80">refresh</span>
            </button>
        </div>
    </nav>

    <!-- Content Grid -->
    <main class="px-6 space-y-6 max-w-4xl mx-auto">
        
        <!-- Row 1: Activity Chart & Category Doughnut -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Activity Chart -->
            <div class="glass p-6 rounded-3xl flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-semibold text-white/90 uppercase tracking-wider">Activity</h3>
                    <span class="text-xs text-white/40">Last 14 Days</span>
                </div>
                <div class="flex-1 min-h-[200px] relative">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <!-- Categories -->
            <div class="glass p-6 rounded-3xl flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-semibold text-white/90 uppercase tracking-wider">Storage</h3>
                    <span class="text-xs text-white/40">By Category</span>
                </div>
                <div class="flex-1 min-h-[200px] relative flex items-center justify-center">
                    <canvas id="categoryChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="text-center">
                             <span id="total-count" class="text-3xl font-bold block">0</span>
                             <span class="text-[10px] uppercase text-white/40 tracking-widest">Items</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Finance Bar Chart -->
        <div class="glass p-6 rounded-3xl">
             <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-neon-lime">payments</span>
                    <h3 class="text-sm font-semibold text-white/90 uppercase tracking-wider">Spending Tracker</h3>
                </div>
                <span class="text-xs text-white/40">Detected Amounts (Last 30 Days)</span>
            </div>
            <div class="h-[200px] w-full">
                <canvas id="financeChart"></canvas>
            </div>
        </div>

        <!-- Row 3: Recent Activity & Languages -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Recent List (Takes up 2 cols) -->
            <div class="md:col-span-2 glass p-6 rounded-3xl flex flex-col">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-semibold text-white/90 uppercase tracking-wider">Recent Analysis</h3>
                </div>
                <div id="recent-list" class="space-y-3 flex-1 overflow-y-auto max-h-[400px] scroller pr-2">
                    <!-- JS Injected -->
                    <div class="animate-pulse flex gap-3">
                        <div class="size-12 bg-white/10 rounded-lg"></div>
                        <div class="flex-1 space-y-2 py-1">
                            <div class="h-3 bg-white/10 rounded w-1/2"></div>
                            <div class="h-2 bg-white/10 rounded w-3/4"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Language Stats (1 col) -->
            <div class="glass p-6 rounded-3xl flex flex-col">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-semibold text-white/90 uppercase tracking-wider">Languages</h3>
                </div>
                 <div class="flex-1 min-h-[150px] relative flex items-center justify-center">
                    <canvas id="languageChart"></canvas>
                </div>
                <div id="lang-legend" class="mt-4 space-y-2 text-xs text-white/60">
                    <!-- Legend -->
                </div>
            </div>
        </div>

    </main>

    <!-- Search Overlay -->
    <div id="search-overlay" class="fixed inset-0 z-[60] bg-background-dark/95 backdrop-blur-xl hidden flex-col p-6 animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Search Vault</h2>
            <button onclick="toggleSearch()" class="size-10 rounded-full glass flex items-center justify-center">
                <span class="material-symbols-outlined text-white">close</span>
            </button>
        </div>
        <div class="relative mb-6">
            <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-white/50">search</span>
            <input type="text" id="search-input" oninput="handleSearch(this.value)" 
                   class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 pl-12 pr-4 text-white placeholder-white/40 focus:outline-none focus:border-primary/50 transition-colors"
                   placeholder="Search text, categories, amounts...">
        </div>
        <div id="search-results" class="flex-1 overflow-y-auto space-y-3"></div>
    </div>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 w-full px-6 pb-6 pt-4 backdrop-blur-2xl bg-background-dark/80 border-t border-white/5 flex justify-between items-center z-50">
        <button class="flex flex-col items-center gap-1 group">
            <span class="material-symbols-outlined text-primary fill-1">dashboard</span>
            <span class="text-[10px] font-bold text-primary">Dash</span>
        </button>
        <button onclick="toggleSearch()" class="flex flex-col items-center gap-1 group opacity-60 hover:opacity-100 transition-opacity">
            <span class="material-symbols-outlined text-white">search</span>
            <span class="text-[10px] font-medium text-white">Search</span>
        </button>
        <div class="relative -top-6">
            <button class="size-14 rounded-full bg-primary flex items-center justify-center shadow-xl shadow-primary/40 border-4 border-[#0f182a] active:scale-95 transition-transform">
                <span class="material-symbols-outlined text-white text-3xl">add_a_photo</span>
            </button>
        </div>
        <button class="flex flex-col items-center gap-1 group opacity-60 hover:opacity-100 transition-opacity">
            <span class="material-symbols-outlined text-white">folder_open</span>
            <span class="text-[10px] font-medium text-white">Files</span>
        </button>
        <button class="flex flex-col items-center gap-1 group opacity-60 hover:opacity-100 transition-opacity">
            <span class="material-symbols-outlined text-white">settings</span>
            <span class="text-[10px] font-medium text-white">Config</span>
        </button>
    </nav>

    <!-- JS Logic -->
    <script>
        // --- Chart Configuration Defaults ---
        Chart.defaults.color = 'rgba(255, 255, 255, 0.5)';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.font.family = 'Inter';

        let charts = {}; // Store chart instances

        async function fetchData() {
            try {
                const res = await fetch('/api/dashboard');
                const data = await res.json();
                renderCharts(data);
                renderRecent(data.recent);
            } catch (e) {
                console.error("Fetch failed", e);
            }
        }

        function renderCharts(data) {
            // 1. Activity Chart (Line)
            const ctxActivity = document.getElementById('activityChart').getContext('2d');
            if (charts.activity) charts.activity.destroy();
            
            const gradientActivity = ctxActivity.createLinearGradient(0, 0, 0, 300);
            gradientActivity.addColorStop(0, 'rgba(40, 119, 246, 0.5)');
            gradientActivity.addColorStop(1, 'rgba(40, 119, 246, 0)');

            charts.activity = new Chart(ctxActivity, {
                type: 'line',
                data: {
                    labels: data.activity.map(d => d.date.slice(5)), // Show MM-DD
                    datasets: [{
                        label: 'Screenshots',
                        data: data.activity.map(d => d.count),
                        borderColor: '#2877f6',
                        backgroundColor: gradientActivity,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#0f182a',
                        pointBorderColor: '#2877f6',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [4, 4] } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // 2. Category Chart (Doughnut)
            const ctxCat = document.getElementById('categoryChart').getContext('2d');
            if (charts.category) charts.category.destroy();
            
            const catColors = ['#2877f6', '#bc13fe', '#39ff14', '#facc15', '#f87171', '#a8a29e'];
            const totalItems = data.categories.reduce((acc, c) => acc + c.count, 0);
            document.getElementById('total-count').textContent = totalItems;

            charts.category = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: data.categories.map(c => c.name),
                    datasets: [{
                        data: data.categories.map(c => c.count),
                        backgroundColor: catColors,
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: { legend: { display: false } }
                }
            });

            // 3. Finance Chart (Bar)
            const ctxFin = document.getElementById('financeChart').getContext('2d');
            if (charts.finance) charts.finance.destroy();
            
            charts.finance = new Chart(ctxFin, {
                type: 'bar',
                data: {
                    labels: data.finance.map(d => d.date.slice(5)),
                    datasets: [{
                        label: 'Spending',
                        data: data.finance.map(d => d.total),
                        backgroundColor: '#39ff14',
                        borderRadius: 4,
                        barThickness: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { borderDash: [4, 4] },
                            ticks: { callback: (val) => '$' + val }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            // 4. Language Chart (Pie)
            const ctxLang = document.getElementById('languageChart').getContext('2d');
            if (charts.language) charts.language.destroy();
            
            if (data.languages && data.languages.length > 0) {
                 charts.language = new Chart(ctxLang, {
                    type: 'pie',
                    data: {
                        labels: data.languages.map(l => l.lang || 'Unknown'),
                        datasets: [{
                            data: data.languages.map(l => l.count),
                            backgroundColor: ['#f472b6', '#60a5fa', '#34d399', '#fbbf24'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }
                    }
                });
            } else {
                // Show placeholder if no languages
                 // ctxLang.canvas.parentNode.innerHTML = '<div class="text-xs text-white/30">No translations yet</div>';
            }
        }

        function renderRecent(items) {
            const list = document.getElementById('recent-list');
            if (!items || items.length === 0) {
                list.innerHTML = '<div class="text-center text-white/30 text-sm">No recent files</div>';
                return;
            }

            list.innerHTML = items.map(item => `
                <div class="glass p-3 rounded-xl flex gap-3 items-start group hover:bg-white/5 transition-colors cursor-pointer">
                    <div class="size-14 rounded-lg bg-center bg-cover border border-white/10 flex-shrink-0 relative overflow-hidden" 
                         style="background-image: url('${item.path.replace("'", "\'"')}')">
                         ${item.is_video ? '<div class="absolute inset-0 flex items-center justify-center bg-black/30"><span class="material-symbols-outlined text-white text-sm">play_circle</span></div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <h4 class="text-white font-medium text-sm truncate pr-2">${item.ai_summary || item.category}</h4>
                            <span class="text-[10px] text-white/40 whitespace-nowrap">${new Date(item.created_at).toLocaleDateString()}</span>
                        </div>
                        <p class="text-xs text-white/50 line-clamp-1 mt-0.5">${item.text_preview || "No text detected"}</p>
                        <div class="flex items-center gap-2 mt-1.5">
                            <span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-white/10 text-white/70 uppercase tracking-wide">${item.category}</span>
                            ${item.amount ? `<span class="text-neon-lime text-[10px] font-bold">$${item.amount}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Search Logic (Reused)
        function toggleSearch() {
            const overlay = document.getElementById('search-overlay');
            overlay.classList.toggle('hidden');
            overlay.classList.toggle('flex');
            if(!overlay.classList.contains('hidden')) document.getElementById('search-input').focus();
        }

        let searchTimeout;
        function handleSearch(query) {
            clearTimeout(searchTimeout);
            const resultsDiv = document.getElementById('search-results');
            if (!query || query.length < 2) {
                resultsDiv.innerHTML = ''; return;
            }
            resultsDiv.innerHTML = '<div class="text-center text-white/50 mt-4">Searching...</div>';
            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const items = await res.json();
                    if (items.length === 0) {
                        resultsDiv.innerHTML = '<div class="text-center text-white/50 mt-10">No matches found.</div>';
                        return;
                    }
                    resultsDiv.innerHTML = items.map(item => `
                        <div class="glass p-3 rounded-xl flex gap-3 items-start animate-fade-in">
                            <div class="size-16 rounded-lg bg-center bg-cover flex-shrink-0 bg-white/5" 
                                 style="background-image: url('${item.path.replace("'", "\'"')}')">
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between">
                                    <h4 class="text-white font-medium text-sm truncate">${item.category}</h4>
                                    ${item.amount ? `<span class="text-neon-lime text-xs font-bold">$${item.amount}</span>` : ''}
                                </div>
                                <p class="text-white/40 text-xs mt-1 line-clamp-2">${item.text_snippet || 'No text content'}</p>
                            </div>
                        </div>
                    `).join('');
                } catch (e) {}
            }, 500);
        }

        // Init
        fetchData();
    </script>
</body>
</html>