<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ScreenSort AI</title>
    <link href="/manifest.json" rel="manifest">
    <meta name="theme-color" content="#111318">
    
    <!-- CSS -->
    <link href="/styles.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />

    <!-- Chart.js (Optional, failure won't break app structure) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- Top App Bar -->
    <header style="position: sticky; top: 0; background: var(--md-sys-color-surface); z-index: 100; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">auto_awesome</span>
            <span class="md-title-large">ScreenSort</span>
        </div>
        <div id="header-actions">
            <!-- Dynamic actions based on view -->
            <button onclick="fetchData()" style="background: none; border: none; color: var(--md-sys-color-on-surface); cursor: pointer;">
                <span class="material-symbols-outlined">refresh</span>
            </button>
        </div>
    </header>

    <!-- VIEWS -->
    <main id="main-content" style="padding: 0 16px 96px 16px;">
        
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="view-section">
            <!-- Stats Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div class="md-card">
                    <span class="md-body-medium">Total Items</span>
                    <div style="font-size: 32px; font-weight: 700; color: var(--md-sys-color-primary);" id="stat-total">...</div>
                </div>
                <div class="md-card">
                    <span class="md-body-medium">Storage</span>
                    <div style="font-size: 32px; font-weight: 700; color: var(--md-sys-color-tertiary);" id="stat-storage">...</div>
                </div>
            </div>

            <!-- Export Button -->
            <button onclick="openExportModal()" style="width: 100%; margin-bottom: 16px; background: var(--md-sys-color-surface-container-high); border: 1px solid var(--md-sys-color-outline-variant); color: var(--md-sys-color-primary); padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span class="material-symbols-outlined">download</span>
                Export Monthly Expenses
            </button>

            <!-- Charts Area -->
            <div class="md-card" style="margin-bottom: 16px; min-height: 200px;">
                <canvas id="activityChart"></canvas>
            </div>

            <div class="md-card" style="margin-bottom: 16px; min-height: 200px;">
                <canvas id="categoryChart"></canvas>
            </div>

            <!-- Recent Activity -->
            <h3 class="md-title-large" style="margin-bottom: 12px;">Recent</h3>
            <div id="recent-list" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Recent items injected here -->
            </div>
        </div>

        <!-- GALLERY VIEW -->
        <div id="view-gallery" class="view-section" style="display: none;">
            <h3 class="md-title-large" style="margin-bottom: 16px;">Categories</h3>
            <div id="category-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                <!-- Categories injected here -->
            </div>
        </div>

        <!-- CATEGORY DETAILS VIEW (Hidden by default) -->
        <div id="view-category-details" class="view-section" style="display: none;">
            <div style="margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="switchView('view-gallery')" style="background:none; border:none; color: var(--md-sys-color-on-surface); cursor: pointer;">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>
                    <h3 id="cat-detail-title" class="md-title-large">Category</h3>
                </div>
                <select id="sort-select" onchange="openCategory(document.getElementById('cat-detail-title').textContent, this.value)" 
                        style="background: var(--md-sys-color-surface-container-high); color: var(--md-sys-color-on-surface); border: none; padding: 8px 12px; border-radius: 8px; font-size: 14px; outline: none;">
                    <option value="date_desc">Newest First</option>
                    <option value="date_asc">Oldest First</option>
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                    <option value="amount_desc">Highest Amount</option>
                </select>
            </div>
            <div id="cat-detail-grid" class="gallery-grid">
                <!-- Images injected here -->
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="view-settings" class="view-section" style="display: none;">
             <div class="md-card">
                <h3>App Info</h3>
                <p class="md-body-medium">Version: 2.0 (Material)</p>
                <p class="md-body-medium">Storage Path: /sdcard/Pictures/Screenshots</p>
            </div>
            
            <button onclick="switchView('view-duplicates')" style="width: 100%; margin-top: 16px; background: var(--md-sys-color-surface-container-high); border: none; color: var(--md-sys-color-on-surface); padding: 16px; border-radius: 12px; font-weight: 500; text-align: left; display: flex; align-items: center; gap: 16px;">
                <span class="material-symbols-outlined">cleaning_services</span>
                Clean Up Duplicates
            </button>
        </div>

        <!-- DUPLICATES VIEW -->
        <div id="view-duplicates" class="view-section" style="display: none;">
            <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
                <button onclick="switchView('view-settings')" style="background:none; border:none; color: var(--md-sys-color-on-surface); cursor: pointer;">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h3 class="md-title-large">Duplicates</h3>
            </div>
            <div id="duplicates-list" style="display: flex; flex-direction: column; gap: 24px;">
                <!-- Duplicates injected here -->
            </div>
        </div>

    </main>

    <!-- SEARCH OVERLAY (Full screen) -->
    <div id="search-overlay" style="position: fixed; inset: 0; background: var(--md-sys-color-background); z-index: 200; padding: 16px; display: none; flex-direction: column;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <button onclick="toggleSearch()" style="background:none; border:none; color: var(--md-sys-color-on-surface);">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <input type="text" id="search-input" placeholder="Search..." 
                   style="flex: 1; background: var(--md-sys-color-surface-container-high); border: none; padding: 12px 16px; border-radius: 24px; color: white; font-size: 16px; outline: none;">
            <button onclick="toggleFilters()" style="background: var(--md-sys-color-surface-container-high); border: none; padding: 10px; border-radius: 50%; color: var(--md-sys-color-primary); cursor: pointer;">
                <span class="material-symbols-outlined">tune</span>
            </button>
        </div>

        <!-- Filter Panel -->
        <div id="filter-panel" style="display: none; background: var(--md-sys-color-surface-container); padding: 16px; border-radius: 12px; margin-bottom: 16px; gap: 12px; flex-direction: column;">
             <div style="display: flex; gap: 8px;">
                 <select id="filter-category" onchange="performSearch()" style="flex: 1; background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 8px;">
                     <option value="">All Categories</option>
                 </select>
             </div>
             <div style="display: flex; gap: 8px; align-items: center;">
                 <span style="font-size: 12px; width: 40px; color: #aaa;">Date:</span>
                 <input type="date" id="filter-date-start" onchange="performSearch()" style="flex: 1; background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 8px;">
                 <span style="color: #aaa;">-</span>
                 <input type="date" id="filter-date-end" onchange="performSearch()" style="flex: 1; background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 8px;">
             </div>
             <div style="display: flex; gap: 8px; align-items: center;">
                 <span style="font-size: 12px; width: 40px; color: #aaa;">$$$:</span>
                 <input type="number" id="filter-amount-min" placeholder="Min" onchange="performSearch()" style="flex: 1; background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 8px;">
                 <span style="color: #aaa;">-</span>
                 <input type="number" id="filter-amount-max" placeholder="Max" onchange="performSearch()" style="flex: 1; background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 8px;">
             </div>
        </div>

        <div id="search-results" style="overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 12px;"></div>
    </div>

    <!-- IMAGE VIEWER MODAL -->
    <div id="image-viewer" style="position: fixed; inset: 0; background: black; z-index: 300; display: none; flex-direction: column; justify-content: center;">
        <button onclick="closeImageViewer()" style="position: absolute; top: 16px; left: 16px; background: rgba(0,0,0,0.5); border: none; color: white; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; z-index: 10;">
            <span class="material-symbols-outlined">close</span>
        </button>
        <img id="viewer-img" src="" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
        <div id="viewer-details" style="padding: 16px; color: white; background: rgba(0,0,0,0.8); position: absolute; bottom: 0; width: 100%; box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div>
                    <h4 id="viewer-filename" style="margin: 0 0 4px 0; word-break: break-all;">Filename</h4>
                    <p id="viewer-date" style="font-size: 12px; opacity: 0.7; margin: 0;">Date</p>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                    <select id="viewer-cat-select" style="background: #333; color: white; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                        <!-- Categories will be injected here -->
                    </select>
                    <button id="move-btn" onclick="updateCategory()" style="background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); border: none; padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; cursor: pointer;">
                        Move
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- EXPORT MODAL -->
    <div id="export-modal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 400; display: none; align-items: center; justify-content: center;">
        <div class="md-card" style="width: 300px; display: flex; flex-direction: column; gap: 16px;">
            <h3 class="md-title-large">Export Expenses</h3>
            <p>Select month to export CSV:</p>
            <input type="month" id="export-month-input" style="padding: 12px; border-radius: 8px; border: 1px solid #555; background: #333; color: white;">
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button onclick="closeExportModal()" style="background: none; border: none; color: white; padding: 8px 16px; cursor: pointer;">Cancel</button>
                <button onclick="runExport()" id="export-confirm-btn" style="background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer;">Export</button>
            </div>
        </div>
    </div>

    <!-- FAB -->
    <button class="md-fab" onclick="toggleSearch()">
        <span class="material-symbols-outlined">search</span>
    </button>

    <!-- Bottom Navigation -->
    <nav class="md-navbar">
        <button class="md-nav-item active" onclick="switchView('view-dashboard', this)">
            <div class="icon-container"><span class="material-symbols-outlined">dashboard</span></div>
            <span>Dash</span>
        </button>
        <button class="md-nav-item" onclick="switchView('view-gallery', this)">
            <div class="icon-container"><span class="material-symbols-outlined">photo_library</span></div>
            <span>Gallery</span>
        </button>
        <button class="md-nav-item" onclick="switchView('view-settings', this)">
            <div class="icon-container"><span class="material-symbols-outlined">settings</span></div>
            <span>Settings</span>
        </button>
    </nav>

    <script>
        // --- Navigation Logic ---
        function switchView(viewId, navBtn) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            // Show target
            document.getElementById(viewId).style.display = 'block';

            // Update Nav State (if triggered by nav button)
            if (navBtn) {
                document.querySelectorAll('.md-nav-item').forEach(el => el.classList.remove('active'));
                navBtn.classList.add('active');
            }

            // Special Logic
            if (viewId === 'view-gallery') {
                loadCategories();
            } else if (viewId === 'view-duplicates') {
                loadDuplicates();
            }
        }

        function toggleSearch() {
            const el = document.getElementById('search-overlay');
            const isHidden = el.style.display === 'none';
            el.style.display = isHidden ? 'flex' : 'none';
            if (isHidden) document.getElementById('search-input').focus();
        }

        // --- Data Fetching ---
        let dashboardData = null;

        async function fetchData() {
            try {
                const res = await fetch('/api/dashboard');
                dashboardData = await res.json();
                renderDashboard(dashboardData);
            } catch (e) {
                console.error("Fetch failed", e);
            }
        }

        function renderDashboard(data) {
            // Stats
            document.getElementById('stat-total').textContent = data.total_photos || 0;
            document.getElementById('stat-storage').textContent = data.storage_usage || '0 MB';

            // Recent List
            const recentContainer = document.getElementById('recent-list');
            recentContainer.innerHTML = data.recent.map(item => {
                // Use the path provided by the API (which already includes /images/...)
                // item.path comes from db_bridge as "/images/Category/filename.jpg"
                const bgImage = `url('${item.path.replace("'", "\\'")}')`;
                
                // Title priority: AI Summary > Text Preview (truncated) > Category
                let title = item.ai_summary || item.category;
                if (!item.ai_summary && item.text_preview) {
                    title = item.text_preview.substring(0, 50) + (item.text_preview.length > 50 ? '...' : '');
                }

                // Escape summary for usage in onclick string
                const safeSummary = (item.ai_summary || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                return `
                <div class="md-card md-card-clickable" onclick="openImage('${item.path}', '${item.name}', '${item.created_at}', '${safeSummary}', '${item.category}')" style="display: flex; gap: 16px; align-items: flex-start; padding: 12px;">
                    <div style="width: 64px; height: 64px; border-radius: 12px; background-image: ${bgImage}; background-size: cover; background-position: center; background-color: #333; flex-shrink: 0;"></div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;">${title}</div>
                        <div style="font-size: 12px; opacity: 0.7; display: flex; align-items: center; gap: 6px;">
                            <span style="background: var(--md-sys-color-surface-container-high); padding: 2px 6px; border-radius: 4px;">${item.category}</span>
                            <span>â€¢ ${new Date(item.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                    ${item.amount ? `<div style="color: var(--md-sys-color-primary); font-weight: 700; font-size: 14px;">$${item.amount}</div>` : ''}
                </div>
                `;
            }).join('');

            // Charts (Simplified)
            if (window.Chart) {
                renderCharts(data);
            }
        }

        function renderCharts(data) {
             const ctxActivity = document.getElementById('activityChart').getContext('2d');
             if (window.chartActivity) window.chartActivity.destroy();
             window.chartActivity = new Chart(ctxActivity, {
                type: 'line',
                data: {
                    labels: data.activity.map(d => d.date.slice(5)),
                    datasets: [{
                        label: 'Screenshots',
                        data: data.activity.map(d => d.count),
                        borderColor: '#a8c7fa',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
             });

             const ctxCat = document.getElementById('categoryChart').getContext('2d');
             if (window.chartCat) window.chartCat.destroy();
             window.chartCat = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: data.categories.map(c => c.name),
                    datasets: [{
                        data: data.categories.map(c => c.count),
                        backgroundColor: ['#a8c7fa', '#bec6dc', '#ddbce0', '#ffb4ab'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
             });
        }

        function loadCategories() {
            if (!dashboardData || !dashboardData.categories) return;
            const container = document.getElementById('category-list');
            container.innerHTML = dashboardData.categories.map(cat => `
                <div class="md-card md-card-clickable" onclick="openCategory('${cat.name}')" style="display: flex; flex-direction: column; align-items: center; justify-content: center; aspect-ratio: 1; text-align: center;">
                    <span class="material-symbols-outlined" style="font-size: 32px; margin-bottom: 8px; color: var(--md-sys-color-primary);">folder</span>
                    <div style="font-weight: 500;">${cat.name}</div>
                    <div style="font-size: 12px; opacity: 0.7;">${cat.count} items</div>
                </div>
            `).join('');
        }

        async function openCategory(name, sort = 'date_desc') {
            document.getElementById('cat-detail-title').textContent = name;
            // Update select value if called programmatically
            document.getElementById('sort-select').value = sort;
            
            switchView('view-category-details');
            
            const grid = document.getElementById('cat-detail-grid');
            grid.innerHTML = '<div style="padding: 20px;">Loading...</div>';

            try {
                const res = await fetch(`/api/category/${name}?sort=${sort}`);
                const data = await res.json();
                
                if (data.files.length === 0) {
                     grid.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.5;">No images found</div>';
                     return;
                }

                grid.innerHTML = data.files.map(file => {
                    // Safe AI Summary for onclick
                    const safeSum = (file.ai_summary || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    
                    return `
                    <div class="gallery-item" onclick="openImage('${file.path}', '${file.name}', '${file.created_at}', '${safeSum}', '${name}')">
                        <img src="${file.path}" loading="lazy">
                        ${file.amount ? `<div style="position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.7); color: #39ff14; font-size: 10px; padding: 2px 4px; border-radius: 4px; font-weight: bold;">$${file.amount}</div>` : ''}
                    </div>
                `}).join('');
            } catch (e) {
                console.error(e);
                grid.innerHTML = 'Error loading category.';
            }
        }

        let currentFile = { name: null, category: null };

        function openImage(path, name, date, summary, category) {
            currentFile = { name: name, category: category };
            
            // Fix path if it's full path
            let src = path;
            if (!src.startsWith('/')) src = '/images/' + path.split('/').pop(); 
            
            if (path.includes('/sdcard/Pictures/Screenshots/')) {
                 src = path.replace('/sdcard/Pictures/Screenshots/', '/images/');
            }
            
            document.getElementById('viewer-img').src = src;
            document.getElementById('viewer-filename').textContent = name;
            document.getElementById('viewer-date').textContent = date ? new Date(parseInt(date) || date).toLocaleString() : '';
            
            // Populate category select
            const catSelect = document.getElementById('viewer-cat-select');
            if (dashboardData && dashboardData.categories) {
                catSelect.innerHTML = dashboardData.categories.map(c => 
                    `<option value="${c.name}" ${c.name === category ? 'selected' : ''}>${c.name}</option>`
                ).join('');
                // Add Unsorted if not in list
                if (!dashboardData.categories.find(c => c.name === 'Unsorted')) {
                     catSelect.innerHTML += `<option value="Unsorted" ${category === 'Unsorted' ? 'selected' : ''}>Unsorted</option>`;
                }
            }

            // Handle AI Summary display
            const detailsDiv = document.getElementById('viewer-details');
            // Remove old summary if exists
            const oldSum = document.getElementById('viewer-summary');
            if(oldSum) oldSum.remove();

            if (summary && summary !== 'null' && summary !== '') {
                const sumEl = document.createElement('p');
                sumEl.id = 'viewer-summary';
                sumEl.style.fontSize = '14px';
                sumEl.style.marginTop = '8px';
                sumEl.style.lineHeight = '1.4';
                sumEl.innerHTML = `<strong>AI Note:</strong> ${summary}`;
                detailsDiv.appendChild(sumEl);
            }

            document.getElementById('image-viewer').style.display = 'flex';
        }

        async function updateCategory() {
            const newCat = document.getElementById('viewer-cat-select').value;
            if (!currentFile.name || newCat === currentFile.category) return;

            const btn = document.getElementById('move-btn');
            const oldText = btn.textContent;
            btn.textContent = 'Moving...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/move-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: currentFile.name, newCategory: newCat })
                });
                const result = await res.json();
                
                if (result.success) {
                    closeImageViewer();
                    // Refresh data
                    await fetchData();
                    // If we were in category view, reload it
                    const currentCatTitle = document.getElementById('cat-detail-title').textContent;
                    const galleryVisible = document.getElementById('view-category-details').style.display === 'block';
                    if (galleryVisible && currentCatTitle !== 'Category') {
                         openCategory(currentCatTitle);
                    }
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('Failed to move file');
            } finally {
                btn.textContent = oldText;
                btn.disabled = false;
            }
        }

        function closeImageViewer() {
            document.getElementById('image-viewer').style.display = 'none';
        }

        function toggleFilters() {
            const el = document.getElementById('filter-panel');
            el.style.display = el.style.display === 'none' ? 'flex' : 'none';
            
            // Populate categories if empty
            const catSelect = document.getElementById('filter-category');
            if (catSelect.options.length <= 1 && dashboardData && dashboardData.categories) {
                dashboardData.categories.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name;
                    opt.textContent = c.name;
                    catSelect.appendChild(opt);
                });
            }
        }

        async function performSearch() {
            const q = document.getElementById('search-input').value;
            const category = document.getElementById('filter-category').value;
            const startDate = document.getElementById('filter-date-start').value;
            const endDate = document.getElementById('filter-date-end').value;
            const minAmount = document.getElementById('filter-amount-min').value;
            const maxAmount = document.getElementById('filter-amount-max').value;
            
            // Allow empty query if filters are set
            const hasFilters = category || startDate || endDate || minAmount || maxAmount;
            if (q.length < 2 && !hasFilters) {
                 document.getElementById('search-results').innerHTML = '';
                 return;
            }

            const params = new URLSearchParams({
                q: q,
                category: category,
                startDate: startDate,
                endDate: endDate,
                minAmount: minAmount,
                maxAmount: maxAmount
            });

            try {
                const res = await fetch(`/api/search?${params.toString()}`);
                const data = await res.json();
                
                if (data.length === 0) {
                     document.getElementById('search-results').innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px;">No results found</div>';
                     return;
                }

                document.getElementById('search-results').innerHTML = data.map(item => `
                    <div class="md-card md-card-clickable" onclick="openImage('${item.path}', '${item.filename}', '${item.created_at}', '', '${item.category}')">
                        <div style="display:flex; justify-content:space-between;">
                            <div style="font-weight: 500;">${item.category}</div>
                            ${item.amount ? `<div style="color:var(--md-sys-color-primary); font-weight:700;">$${item.amount}</div>` : ''}
                        </div>
                        <div style="font-size: 12px; opacity: 0.7;">${item.text_snippet || 'No text'}</div>
                        <div style="font-size: 10px; opacity: 0.5; margin-top:4px;">${new Date(item.created_at).toLocaleDateString()}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        // Search Logic
        document.getElementById('search-input').addEventListener('input', performSearch);

        function openExportModal() {
            document.getElementById('export-modal').style.display = 'flex';
            // Default to current month
            const now = new Date();
            const monthStr = now.toISOString().slice(0, 7);
            document.getElementById('export-month-input').value = monthStr;
        }

        function closeExportModal() {
            document.getElementById('export-modal').style.display = 'none';
        }

        async function runExport() {
            const month = document.getElementById('export-month-input').value;
            if (!month) return;

            const btn = document.getElementById('export-confirm-btn');
            const oldText = btn.textContent;
            btn.textContent = 'Exporting...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ month: month })
                });
                const result = await res.json();
                
                if (result.success) {
                    alert(`Export successful!\nFound ${result.count} items.\nSaved to: ${result.path}`);
                    closeExportModal();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('Export failed');
            } finally {
                btn.textContent = oldText;
                btn.disabled = false;
            }
        }

        async function loadDuplicates() {
            const container = document.getElementById('duplicates-list');
            container.innerHTML = '<div style="padding:20px;">Scanning...</div>';
            
            try {
                const res = await fetch('/api/duplicates');
                const groups = await res.json();
                
                if (groups.length === 0) {
                    container.innerHTML = '<div style="padding:20px; text-align:center;">No duplicates found!</div>';
                    return;
                }
                
                container.innerHTML = groups.map((group, idx) => `
                    <div class="md-card">
                        <div style="margin-bottom:12px; font-weight:500;">Group ${idx + 1}</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                            ${group.map(item => `
                                <div style="display:flex; flex-direction:column; gap:8px;">
                                    <img src="${item.path}" style="width:100%; border-radius:8px; aspect-ratio:9/16; object-fit:cover; background:#000;">
                                    <div style="font-size:10px; opacity:0.7;">
                                        <div>${new Date(item.created_at).toLocaleDateString()}</div>
                                        <div style="word-break:break-all;">${item.filename}</div>
                                    </div>
                                    <button onclick="deleteFile('${item.filename}')" style="background:var(--md-sys-color-error); color:var(--md-sys-color-on-error); border:none; padding:6px; border-radius:8px; cursor:pointer;">Delete</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
                container.innerHTML = 'Error loading duplicates.';
            }
        }

        async function deleteFile(filename) {
            if (!confirm('Are you sure you want to delete this file? This cannot be undone.')) return;
            
            try {
                const res = await fetch(`/api/file/${filename}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    loadDuplicates(); // Refresh
                } else {
                    alert('Failed to delete: ' + result.error);
                }
            } catch (e) {
                console.error(e);
                alert('Error deleting file');
            }
        }

        // Initialize
        fetchData();
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js');
        }
    </script>
</body>
</html>